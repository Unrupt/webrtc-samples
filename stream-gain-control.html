<!doctype html>
<html lang="en">

    <head>
        <title>Gain Controller</title>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"  />
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <style>
            .btn-fn {
                display: block;
                width: 70%;
                max-width: 300px;
                margin: 15px auto;
            }
            #audio {
                display: block;
                width: 70%;
                max-width: 300px;
                margin: 10px auto;
            }
        </style>
    </head>
    <body>
        <h2 class="w3-center">Media Stream with Gain Control</h2>
        <p class="w3-center">The aim of this sample is to control the gain of the stream</p>
        <audio id="audio" playsinline="true" controls autoplay></audio><br>
        <button class="btn-fn" onclick="start()">Start!</button>
        <button class="btn-fn" onclick="updateGain(0.001)">Low Gain</button>
        <button class="btn-fn" onclick="updateGain(1)">Default Gain</button>
        <script src="webrtc-lib.js"></script>
        <script>

            var localStream;
            var gainNode;
            var ctx;
            var dst;
            var start = () => navigator.mediaDevices.getUserMedia({audio: true})
              .then(stream => audio.srcObject = modifyGain(stream, 2.5))
              .catch(e => log(e));

            var modifyGain = (stream, gainValue) => {
                localStream = stream;
              ctx = new AudioContext();
              var src = ctx.createMediaStreamSource(stream);
              dst = ctx.createMediaStreamDestination();
              gainNode = ctx.createGain();
              gainNode.gain.value = gainValue;
              src.connect(gainNode);
              gainNode.connect(dst);
              outputStream = dst.stream;
              stream.addTrack(outputStream.getAudioTracks()[0]);
              stream.removeTrack(stream.getAudioTracks()[0]);
              //[src, gainNode, dst].reduce((a, b) => a && a.connect(b));
              return stream;
            };

            var updateGain = (value) => {
              gainNode.gain.value = value;
            };

            var log = msg => div.innerHTML += "<br>" + msg;
        </script>
    </body>
</html>
